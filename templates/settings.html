{% extends "base.html" %}

{% block title %}设置{% endblock %}

{% block head %}

{% endblock %}

{% block content %}
{% if show_upload_notice %}
<div class="alert-message">
    <div class="alert-icon">
        <i class="fas fa-exclamation-circle"></i>
    </div>
    <div class="alert-content">
        <div class="alert-title">需要上传数据</div>
        <div class="alert-description">
            请先上传支付宝账单文件，系统将为您生成详细的消费分析报告。
            <br>
            上传后的数据将在本地进行分析，30分钟后自动清除，请放心使用。
        </div>
    </div>
</div>
{% endif %}

<div class="page-header">
    <h1 class="page-title">文件管理</h1>
</div>

<div class="upload-section">
    <h2 class="upload-title">上传账单文件</h2>
    <div class="session-timer">
        <i class="fas fa-clock"></i>
        <span>会话剩余时间: <span id="timeRemaining">--:--</span></span>
    </div>
    <p class="upload-description">
        支持上传支付宝账单CSV文件。请确保文件包含必要的字段：交易时间、交易分类、收/支、金额、商品说明、交易状态、交易对方。
    </p>

    <div class="upload-guide">
        <h3>如何获取支付宝账单？</h3>
        <ol>
            <li>打开支付宝 App -> 我的 -> 账单</li>
            <li>右上角 ... -> 开具交易流水证明 -> 用于个人对账 -> 申请</li>
            <li>自定义时间范围（最长为一年） -> 填写邮箱 -> 下载账单</li>
            <li>申请记录中找到解压密码 -> 解压下载的文件，获取 CSV 文件</li>
            <li>按年份重命名为【alipay_record_2024.csv】格式</li>
        </ol>
    </div>

    <label class="file-upload" id="uploadArea">
        <input type="file" id="fileInput" accept=".csv" multiple>
        <div class="upload-icon">
            <i class="fas fa-cloud-upload-alt"></i>
        </div>
        <div class="upload-text">
            点击或拖拽文件到此处上传<br>
            <span style="font-size: 12px; opacity: 0.7;">支持 CSV 格式，最大 16MB</span>
        </div>
    </label>

    <div class="file-list" id="fileList">
        <!-- 已上传文件列表将通过 JavaScript 动态添加 -->
    </div>
</div>

<!-- 在 upload-section 后面添加删除区域 -->
<div class="delete-section">
    <h2 class="section-title">数据管理</h2>
    <div class="delete-area">
        <button id="deleteAllBtn" class="delete-all-btn">
            <i class="fas fa-trash-alt"></i>
            删除所有账单数据
        </button>
        <p class="delete-warning">删除后将清空所有已上传的账单文件和分析数据，此操作不可恢复。</p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const fileList = document.getElementById('fileList');
        const maxFileSize = 16 * 1024 * 1024; // 16MB

        // 添加文件大小检查
        function checkFileSize(file) {
            if (file.size > maxFileSize) {
                showError(`文件 ${file.name} 超过大小限制（16MB）`, uploadArea);
                return false;
            }
            return true;
        }

        // 处理文件上传
        async function uploadFile(file) {
            if (!checkFileSize(file)) return;

            const formData = new FormData();
            formData.append('file', file);

            const fileItem = createFileItem(file.name, '准备上传...');
            fileList.appendChild(fileItem);

            // 添加进度条
            const progressDiv = document.createElement('div');
            progressDiv.className = 'upload-progress';
            progressDiv.innerHTML = '<div class="progress-bar"></div>';
            fileItem.appendChild(progressDiv);
            progressDiv.style.display = 'block';

            try {
                const response = await fetchWithRetry('/api/upload', {
                    method: 'POST',
                    body: formData
                }, 3);

                const data = await response.json();
                if (data.success) {
                    updateFileItem(fileItem, data.filename, true, data.message);
                    showToast('文件上传成功');
                    handleUploadSuccess();
                } else {
                    updateFileItem(fileItem, file.name, false, data.error);
                    showError(data.error);
                }
            } catch (error) {
                updateFileItem(fileItem, file.name, false, '上传失败，请重试');
                showError('网络错误，请重试');
            }
        }

        // 添加移动端检测
        function isMobile() {
            return window.innerWidth <= 768;
        }

        // 根据设备类型调整界面
        function adjustForDevice() {
            if (isMobile()) {
                uploadArea.querySelector('.upload-text').innerHTML = '点击上传文件<br><span style="font-size: 12px; opacity: 0.7;">支持 CSV 格式，最大 16MB</span>';
            } else {
                uploadArea.querySelector('.upload-text').innerHTML = '点击或拖拽文件到此处上传<br><span style="font-size: 12px; opacity: 0.7;">支持 CSV 格式，最大 16MB</span>';
            }
        }

        // 监听窗口大小变化
        window.addEventListener('resize', adjustForDevice);
        adjustForDevice();

        // 优化拖拽效果
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            handleFiles(files);
        });

        // 处理文件选择
        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });

        // 加载现有文件列表
        loadExistingFiles();

        function handleFiles(files) {
            Array.from(files).forEach(file => {
                if (file.name.endsWith('.csv')) {
                    uploadFile(file);
                }
            });
        }

        function loadExistingFiles() {
            fetch('/api/files')
                .then(response => response.json())
                .then(data => {
                    data.files.forEach(file => {
                        const fileItem = createFileItem(file.name, '已上传', true);
                        fileList.appendChild(fileItem);
                    });
                });
        }

        function createFileItem(filename, status, isSuccess = null) {
            const item = document.createElement('div');
            item.className = 'file-item';
            item.innerHTML = `
            <i class="fas fa-file-csv"></i>
            <span class="file-name">${filename}</span>
            <span class="file-status ${isSuccess === null ? '' : isSuccess ? 'status-success' : 'status-error'}">${status}</span>
            ${isSuccess !== null ? `
                <button class="delete-btn" onclick="deleteFile('${filename}')">
                    <i class="fas fa-trash"></i>
                </button>
            ` : ''}
        `;
            return item;
        }

        function updateFileItem(item, filename, success, message) {
            item.querySelector('.file-name').textContent = filename;
            item.querySelector('.file-status').textContent = message;
            item.querySelector('.file-status').className = `file-status ${success ? 'status-success' : 'status-error'}`;

            if (!item.querySelector('.delete-btn')) {
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-btn';
                deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
                deleteBtn.onclick = () => deleteFile(filename);
                item.appendChild(deleteBtn);
            }
        }

        window.deleteFile = function (filename) {
            if (confirm(`确定要删除文件 ${filename} 吗？`)) {
                fetch(`/api/files/${filename}`, {
                    method: 'DELETE'
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            const fileItems = fileList.getElementsByClassName('file-item');
                            Array.from(fileItems).forEach(item => {
                                if (item.querySelector('.file-name').textContent === filename) {
                                    item.remove();
                                }
                            });
                        }
                    });
            }
        }

        // 修改计时器更新函数
        function updateTimer() {
            if (window.isRedirecting) return;

            fetch('/api/session/time_remaining')
                .then(response => response.json())
                .then(data => {
                    const timeDisplay = document.getElementById('timeRemaining');

                    // 如果会话还未开始（没有上传文件）
                    if (!data.hasOwnProperty('remaining')) {
                        timeDisplay.textContent = '--:--';
                        return;
                    }

                    const remaining = data.remaining;
                    if (remaining <= 0 || data.expired) {
                        timeDisplay.textContent = '已过期';
                        // 只在有文件的情况下才重定向
                        if (localStorage.getItem('isUploading')) {
                            window.isRedirecting = true;
                            localStorage.removeItem('isUploading');
                            window.location.href = '/';
                        }
                        return;
                    }

                    const minutes = Math.floor(remaining / 60);
                    const seconds = remaining % 60;
                    timeDisplay.textContent =
                        `${minutes}:${seconds.toString().padStart(2, '0')}`;
                });
        }

        // 在文件上传成功时开始计时
        function handleUploadSuccess() {
            // 标记正在上传状态
            localStorage.setItem('isUploading', 'true');
            updateTimer();
            setInterval(updateTimer, 1000);
        }

        // 在页面加载时检查是否需要开始计时
        if (localStorage.getItem('isUploading')) {
            updateTimer();
            setInterval(updateTimer, 1000);
        }

        // 添加删除按钮事件处理
        document.getElementById('deleteAllBtn').addEventListener('click', function () {
            if (confirm('确定要删除所有账单数据吗？此操作不可恢复！')) {
                fetch('/api/clear_data', {
                    method: 'POST'
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // 清除本地存储的上传状态
                            localStorage.removeItem('isUploading');
                            // 刷新文件列表
                            fileList.innerHTML = '';
                            // 重置计时器显示
                            document.getElementById('timeRemaining').textContent = '--:--';
                            // 显示成功提示
                            showToast('所有数据已清除');
                        } else {
                            showToast('删除失败：' + data.error);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        showToast('删除失败，请重试');
                    });
            }
        });
    });
</script>
{% endblock %}